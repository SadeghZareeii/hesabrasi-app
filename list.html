<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="سامانه ثبت و مدیریت اطلاعات مددجویان" />
    <meta name="author" content="Sadegh" />
    <meta name="robots" content="noindex, nofollow" />
    <meta name="theme-color" content="#007bff" />
    <title>لیست مددجویان</title>
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <h1>لیست اطلاعات ثبت‌شده</h1>
    <button id="goBackBtn">برگشت به صحفه اصلی</button>
    <input id="search" placeholder="جستجو بر اساس نام یا نام خانوادگی" />
    <div class="table-wrapper">
      <table id="table">
        <thead>
          <tr id="field-row"></tr>
        </thead>
        <tbody id="data-rows"></tbody>
      </table>
    </div>
    <div id="pagination" class="pagination"></div>

    <!-- مودال ویرایش -->
    <div id="edit-modal" class="modal" style="display: none">
      <div class="modal-content">
        <h2>ویرایش اطلاعات مددجو</h2>
        <form id="edit-form"></form>
        <button id="saveEditBtn">ذخیره</button>
        <button id="cancelEditBtn">لغو</button>
      </div>
    </div>

    <div
      id="listModal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #00000088;
        z-index: 999;
        justify-content: center;
        align-items: center;
      "
    >
      <div
        style="
          background: white;
          padding: 20px;
          border-radius: 8px;
          text-align: center;
          width: 420px;
          height: 150px;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: space-evenly;
        "
      >
        <p id="listCaption" style="font-family: 'titr'"></p>
        <button id="okModalBtn" style="margin: 5px; width: 70px">بستن</button>
      </div>
    </div>

    <!-- modal Delet -->
    <div id="confirm-modal" class="modal-confirm">
      <div class="modal-content__confirm">
        <p id="confirm-message"></p>
        <div class="modal-actions__confirm">
          <button id="confirm-yes">بله</button>
          <button id="confirm-no">خیر</button>
        </div>
      </div>
    </div>
    <script src="renderer/app.js"></script>
    <script>
      // modal Delet fun
      function openConfirmModal(message, onConfirm) {
        const modal = document.getElementById("confirm-modal");
        const msg = document.getElementById("confirm-message");
        const yesBtn = document.getElementById("confirm-yes");
        const noBtn = document.getElementById("confirm-no");

        msg.textContent = message;
        modal.style.display = "flex";

        // پاک کردن لیسنرهای قبلی
        yesBtn.onclick = null;
        noBtn.onclick = null;

        yesBtn.onclick = () => {
          modal.style.display = "none";
          onConfirm(true);
        };
        noBtn.onclick = () => {
          modal.style.display = "none";
          onConfirm(false);
        };
      }

      const openModalAddList = (string) => {
        listModal.style.display = "flex";
        listCaption.textContent = string;
      };

      okModalBtn.onclick = () => {
        listModal.style.display = "none";
        listCaption.textContent = "";
      };

      window.onload = () => initListPage();
      // Global list actions
      window.editItem = function (index) {
        editIndex = index;
        const item = data[index];
        const form = document.getElementById("edit-form");
        const modal = document.getElementById("edit-modal");

        if (!form || !modal || !item) return;

        form.innerHTML = "";

        getAllFields().forEach((field) => {
          const wrapper = document.createElement("div");
          wrapper.className = "form-row";

          const label = document.createElement("label");
          label.textContent = field;
          label.setAttribute("for", field);

          const input =
            field === "توضیحات"
              ? document.createElement("textarea")
              : document.createElement("input");

          input.name = field;
          input.id = field;
          input.value = item[field] || "";
          input.placeholder = field;

          wrapper.appendChild(label);
          wrapper.appendChild(input);
          form.appendChild(wrapper);
        });

        modal.style.display = "flex";
      };

      window.deleteItem = async (index) => {
        const item = data[index];
        if (!item) return;

        openConfirmModal(
          `آیا "${item["نام"] || ""} ${item["نام خانوادگی"] || ""}" حذف شود؟`,
          async (confirmed) => {
            if (!confirmed) return;

            data.splice(index, 1);

            try {
              await ipcRenderer.invoke("save-data", data);
              window.location.reload();
              renderTable();
            } catch (err) {
              openModalAddList("خطا در ذخیره پس از حذف:\n" + err);
            }
          }
        );
      };

      window.printItem = (index) => {
        const item = data[index];
        if (!item) return;
        try {
          localStorage.setItem("printData", JSON.stringify(item));
        } catch (err) {
          console.error("LocalStorage set error:", err);
          openModalAddList(
            "خطا در چاپ " + "\n" + "LocalStorage set error:",
            err
          );
        }
        location.href = "print.html";
      };
    </script>
  </body>
</html>
