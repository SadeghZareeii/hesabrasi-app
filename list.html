<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="سامانه ثبت و مدیریت اطلاعات مددجویان" />
    <meta name="author" content="Sadegh" />
    <meta name="robots" content="noindex, nofollow" />
    <meta name="theme-color" content="#007bff" />
    <title>لیست مددجویان</title>
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <h1>لیست اطلاعات ثبت‌شده</h1>
    <button id="goBackBtn">برگشت به صحفه اصلی</button>
    <input id="search" placeholder="جستجو بر اساس نام یا نام خانوادگی" />
    <div class="table-wrapper">
      <table id="table">
        <thead>
          <tr id="field-row"></tr>
        </thead>
        <tbody id="data-rows"></tbody>
      </table>
    </div>
    <div id="pagination" class="pagination"></div>

    <!-- مودال ویرایش -->
    <div id="edit-modal" class="modal" style="display: none">
      <div class="modal-content">
        <h2>ویرایش اطلاعات مددجو</h2>
        <form id="edit-form"></form>
        <button id="saveEditBtn">ذخیره</button>
        <button id="cancelEditBtn">لغو</button>
      </div>
    </div>

    <script src="renderer/app.js"></script>
    <script>
      window.onload = () => initListPage();
      // Global list actions
      window.editItem = function (index) {
        editIndex = index;
        const item = data[index];
        const form = document.getElementById("edit-form");
        const modal = document.getElementById("edit-modal");

        if (!form || !modal || !item) return;

        form.innerHTML = "";

        getAllFields().forEach((field) => {
          const wrapper = document.createElement("div");
          wrapper.className = "form-row";

          const label = document.createElement("label");
          label.textContent = field;
          label.setAttribute("for", field);

          const input =
            field === "توضیحات"
              ? document.createElement("textarea")
              : document.createElement("input");

          input.name = field;
          input.id = field;
          input.value = item[field] || "";
          input.placeholder = field;

          wrapper.appendChild(label);
          wrapper.appendChild(input);
          form.appendChild(wrapper);
        });

        modal.style.display = "flex";
      };

      window.deleteItem = async (index) => {
        const item = data[index];
        if (!item) return;

        const confirmed = confirm(
          `آیا "${item["نام"] || ""} ${item["نام خانوادگی"] || ""}" حذف شود؟`
        );
        if (!confirmed) return;

        // Remove and persist (keep current order)
        data.splice(index, 1);

        try {
          await ipcRenderer.invoke("save-data", data);
          // بعد از ذخیره موفق، صفحه رفرش بشه
          window.location.reload();
          renderTable();
        } catch (err) {
          console.error("Delete save error:", err);
          alert("خطا در ذخیره پس از حذف ❌");
        }
      };

      window.printItem = (index) => {
        const item = data[index];
        if (!item) return;
        try {
          localStorage.setItem("printData", JSON.stringify(item));
        } catch (err) {
          console.error("LocalStorage set error:", err);
        }
        location.href = "print.html";
      };
    </script>
  </body>
</html>
